<?php include COMMON_PATH.'/header.html';?>
<div class="layui-container fly-marginTop fly-user-main">
    <?php include COMMON_PATH.'/member-nav.html';?>
    <div class="fly-panel fly-panel-user" pad20>
        <div class="layui-tab layui-tab-brief" lay-filter="api">
            <ul class="layui-tab-title" id="LAY_mine">
                <li class="layui-this" lay-id="api">API配置</li>
                <li lay-id="api_info"><a href="/member/api/doc/">API说明</a></li>
            </ul>
            <div class="layui-tab-content" style="padding: 20px 0;">
                <div class="layui-form layui-form-pane layui-tab-item layui-show">
                    <div class="layui-form-item layui-show">
                        <?php if(is_array($api) AND !empty($api)):?>
                        <div class="layui-elem-quote">
                            <p>您已经成功申请API，您还需要配置安全IP，才可以正常使用。<button class="layui-btn layui-btn-sm layui-btn-danger" lay-filter="shutdown" lay-submit>关闭API</button></p>
                        </div>

						<form class="layui-form layui-show" method="post">
							<div class="layui-form-item">
								<label for="apikey" class="layui-form-label">apikey</label>
								<div class="layui-input-inline">
									<input type="text" id="apikey" disabled autocomplete="off" value="<?php echo $api['apikey'];?>" class="layui-input">
								</div>
							</div>
							<div class="layui-form-item">
								<label for="apisecret" class="layui-form-label">apisecret</label>
								<div class="layui-input-inline">
									<input type="text" id="apisecret" disabled name="apisecret" required lay-verify="required" autocomplete="off" value="<?php echo $api['apisecret'];?>" class="layui-input">
								</div>
							</div>
							<div class="layui-form-item">
								<label for="expirytime" class="layui-form-label">到期时间</label>
								<div class="layui-input-inline">
									<input type="text" id="expirytime" name="expirytime" disabled autocomplete="off" lay-verify="expirytime" value="<?php echo date('Y-m-d H:i:s',$api['expirytime']);?>" class="layui-input">
								</div>
							</div>
							<div class="layui-form-item layui-form-text">
								<label for="L_sign" class="layui-form-label">授权IP(一行一个,回车)</label>
								<div class="layui-input-block">
									<textarea placeholder="" id="L_sign" name="tag" autocomplete="off" class="layui-textarea" style="height: 80px;"><?php echo $api['allowip'];?></textarea>
								</div>
							</div>
							<div class="layui-form-item">
								<button class="layui-btn" key="set-mine" lay-filter="profiles" lay-submit>确认修改</button>
							</div>
						</form>
                        <?php else:?>
                        <div class="layui-elem-quote">
                            <p>申请API，您可以自主管理</p>
                        </div>
                        <button class="layui-btn" lay-filter="api" lay-submit>申请开通</button>
                        <?php endif;?>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<!--引入公共底文件-->
<?php include COMMON_PATH.'/footer.html';?>
<script>
	layui.use(['form', 'layer'], function(){
		var $ = layui.$;
		var form = layui.form;
		var layer = layui.layer;
		form.on('submit(api)', function(data){
			data.field.method = 'on';
			data.field.csrf_token = TOKEN;
			var i = layer.load(2,{shade: [0.5,'#fff']});
			$.ajax({
				url: '/member/api/ajax',
				type: 'post',
				dataType: 'json',
				data: data.field,
			})
			.done(function(res) {
				if (res.code == '1') {
					layer.open({
					title: '提示',
					icon: 1,
					content: res.msg,
					btn: ['确定'],
					yes: function(index, layero){
					    location.reload();
					},
					cancel: function(){
					    location.reload();
					}
				});
				} else {
					layer.msg(res.msg,{icon:2,time:5000});
				}
			})
			.fail(function() {
				layer.msg('服务器连接失败，请联系管理员',{icon:2,time:5000});
			})
			.always(function() {
				layer.close(i);
			});

			return false; //阻止表单跳转。
		});
		form.on('submit(shutdown)', function(data){
			data.field = {};
			data.field.method = 'off';
			data.field.csrf_token = TOKEN;
			var i = layer.load(2,{shade: [0.5,'#fff']});
			$.ajax({
				url: '/member/api/ajax',
				type: 'post',
				dataType: 'json',
				data: data.field,
			})
			.done(function(res) {
				if (res.code == '1') {
					var n = layer.open({
						title: '提示',
						icon: 1,
						content: res.msg,
						btn: ['确定'],
						yes: function(index, layero){
						    location.reload();
						},
						cancel: function(){
						    location.reload();
						}
					});
				} else {
					layer.msg(res.msg,{icon:2,time:5000});
				}
			})
			.fail(function() {
				layer.msg('服务器连接失败，请联系管理员',{icon:2,time:5000});
			})
			.always(function() {
				layer.close(i);
			});

			return false; //阻止表单跳转。
		});
	})
</script>